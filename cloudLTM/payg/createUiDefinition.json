{
     "handler": "Microsoft.Compute.MultiVm",
     "version": "0.1.2-preview",
     "parameters": {
          "basics": [
          ],
          "steps": [
               {
                    "name": "infrastructureSettings",
                    "label": "Infrastructure Settings",
                    "subLabel": {
                         "preValidation": "Configure Infrastructure Settings",
                         "postValidation": "Done"
                    },
                    "bladeTitle": "Infrastructure Settings",
                    "elements": [
                         {
                              "name": "solutionDeploymentName",
                              "type": "Microsoft.Common.TextBox",
                              "label": "Deployment Name",
                              "toolTip": "A friendly name for this deployment.",
                              "defaultValue": "F5waf",
                              "constraints": {
                                   "required": true,
                                   "regex": "^[a-z0-9A-Z]{1,10}$",
                                   "validationMessage": "Only letters and numbers are allowed, and the value must be 1-10 characters long"
                              }
                         },
                         {
                              "name": "bigIpVersion",
                              "type": "Microsoft.Common.OptionsGroup",
                              "label": "BIG-IP Version",
                              "defaultValue": "13.0.21",
                              "toolTip": "F5 BIG-IP version you want to use.",
                              "constraints": {
                                   "allowedValues": [
                                        {
                                             "label": "13.0.21",
                                             "value": "13.0.21"
                                        },
                                        {
                                             "label": "12.1.24",
                                             "value": "12.1.24"
                                        }
                                   ]
                              }
                         },
                         {
                              "name": "imageName",
                              "type": "Microsoft.Common.OptionsGroup",
                              "label": "BIG-IP Image Name",
                              "defaultValue": "Best",
                              "toolTip": "F5 SKU (IMAGE) you want to deploy.",
                              "constraints": {
                                   "allowedValues": [
                                        {
                                             "label": "Good",
                                             "value": "good"
                                        },
                                        {
                                             "label": "Better",
                                             "value": "better"
                                        },
                                        {
                                             "label": "Best",
                                             "value": "best"
                                        }
                                   ]
                              }
                         },
                         {
                             "name": "vmScaleSetMinCount",
                              "type": "Microsoft.Common.DropDown",
                              "label": "Minimum Number of BIG-IP VEs",
                              "defaultValue": "2",
                              "toolTip": "The minimum (and default) number of BIG-IP VEs that will be deployed into the VM Scale Set.",
                              "constraints": {
                                   "allowedValues": [
                                       {
                                            "label": "1",
                                            "value": "1"
                                       },
                                       {
                                            "label": "2",
                                            "value": "2"
                                       },
                                       {
                                            "label": "3",
                                            "value": "3"
                                       },
                                       {
                                            "label": "4",
                                            "value": "4"
                                       },
                                       {
                                            "label": "5",
                                            "value": "5"
                                       },
                                       {
                                            "label": "6",
                                            "value": "6"
                                       }
                                   ]
                              }
                         },
                         {
                              "name": "licensedBandwidth",
                              "type": "Microsoft.Common.DropDown",
                              "label": "Licensed Bandwidth",
                              "defaultValue": "200M",
                              "toolTip": "The amount of licensed bandwidth (Mbps) to allocate for each BIG-IP VE.",
                              "constraints": {
                                   "allowedValues": [
                                        {
                                             "label": "25M",
                                             "value": "25m"
                                        },
                                        {
                                             "label": "200M",
                                             "value": "200m"
                                        },
                                        {
                                             "label": "1G",
                                             "value": "1g"
                                        }
                                   ]
                              }
                         },
                         {
                              "name": "adminUsername",
                              "type": "Microsoft.Compute.UserNameTextBox",
                              "label": "F5 WAF Username",
                              "defaultValue": "azureuser",
                              "toolTip": "Administrative username for the Azure virtual machine(s).",
                              "osPlatform": "Windows"
                         },
                         {
                              "name": "adminPassword",
                              "type": "Microsoft.Compute.CredentialsCombo",
                              "label": {
                                   "password": "F5 WAF Password",
                                   "confirmPassword": "Confirm Password"
                              },
                              "toolTip": {
                                   "password": "Administrative password for the Azure virtual machine(s)."
                              },
                              "constraints": {
                                   "required": true
                              },
                              "options": {
                                   "hideConfirmation": false
                              },
                              "osPlatform": "Windows"
                         },
                         {
                              "name": "instanceType",
                              "type": "Microsoft.Compute.SizeSelector",
                              "label": "Virtual machine size",
                              "toolTip": "The size of virtual machine to provision for each cluster node.",
                              "recommendedSizes": [
                                   "Standard_DS2_v2",
                                   "Standard_DS3_v2"
                              ],
                              "constraints": {
                                   "allowedSizes": [
                                        "Standard_DS2",
                                        "Standard_DS3",
                                        "Standard_DS4",
                                        "Standard_DS11",
                                        "Standard_DS12",
                                        "Standard_DS13",
                                        "Standard_DS14",
                                        "Standard_DS2_v2",
                                        "Standard_DS3_v2",
                                        "Standard_DS4_v2",
                                        "Standard_DS5_v2",
                                        "Standard_DS11_v2",
                                        "Standard_DS12_v2",
                                        "Standard_DS13_v2",
                                        "Standard_DS14_v2",
                                        "Standard_DS15_v2",
                                        "Standard_F2S",
                                        "Standard_F4S",
                                        "Standard_F8S"
                                   ]
                              },
                              "osPlatform": "Linux",
                              "imageReference": {
                                   "publisher": "f5-networks",
                                   "offer": "f5-big-ip-hourly",
                                   "sku": "[concat('f5-bigip-virtual-edition-', steps('infrastructureSettings').licensedBandwidth, '-', steps('infrastructureSettings').imageName,'-hourly')]"
                              },
                              "count": "[int(steps('infrastructureSettings').vmScaleSetMinCount)]",
                              "visible": true
                         },
                         {
                              "name": "managedDisks",
                              "type": "Microsoft.Common.OptionsGroup",
                              "label": "Use managed disks",
                              "defaultValue": "Yes",
                              "toolTip": "Enable this feature to have Azure automatically manage the availability of disks to provide data redundancy and fault tolerance, without creating and managing storage accounts on your own.",
                              "constraints": {
                                   "allowedValues": [
                                        {
                                             "label": "Yes",
                                             "value": "yes"
                                        },
                                        {
                                             "label": "No",
                                             "value": "no"
                                        }
                                   ]
                              }
                         },
                         {
                             "name": "storageAccount",
                              "type": "Microsoft.Storage.StorageAccountSelector",
                              "label": "Storage Account",
                              "toolTip": "Select a new or existing storage account for your BIG-IP virtual machines. For autoscale solutions, only premium storage is allowed.",
                              "defaultValue": {
                                   "name": "wafst",
                                   "type": "Premium_LRS"
                              },
                              "constraints": {
                                "allowedTypes": [
                                    "Premium_LRS"
                                ]
                              },
                              "visible": "[equals(steps('infrastructureSettings').managedDisks, 'no')]"
                         },
                         {
                              "name": "publicIp",
                              "type": "Microsoft.Network.PublicIpAddressCombo",
                              "label": {
                                   "publicIpAddress": "Public IP address",
                                   "domainNameLabel": "Domain name label"
                              },
                              "toolTip": {
                                   "publicIpAddress": "",
                                   "domainNameLabel": ""
                              },
                              "defaultValue": {
                                   "publicIpAddressName": "ltm-pip"
                              },
                              "constraints": {
                                   "required": {
                                        "domainNameLabel": true
                                   }
                              },
                              "options": {
                                   "hideNone": true,
                                   "hideDomainNameLabel": false,
                                   "hideExisting": false
                              },
                              "visible": true
                         },
                         {
                              "name": "virtualNetwork",
                              "type": "Microsoft.Network.VirtualNetworkCombo",
                              "label": {
                                   "virtualNetwork": "Virtual network",
                                   "subnets": "Subnets"
                              },
                              "toolTip": {
                                   "virtualNetwork": "Select an existing new virtual network or use the template to create a new one.",
                                   "subnets": "Select an existing subnet or use the template to create a new one."
                              },
                              "defaultValue": {
                                   "name": "waf-vnet",
                                   "addressPrefixSize": "/16"

                              },
                              "constraints": {
                                   "minAddressPrefixSize": "/22"
                              },
                              "options": {
                                   "hideExisting": false
                              },
                              "subnets": {
                                   "subnet1": {
                                        "label": "Subnet",
                                        "defaultValue": {
                                             "name": "subnet1",
                                             "addressPrefixSize": "/24"
                                        },
                                        "constraints": {
                                             "minAddressPrefixSize": "/28",
                                             "minAddressCount": 2,
                                             "requireContiguousAddresses": true
                                        }
                                   }
                              },
                              "visible": true
                         },
                         {
                              "name": "restrictedSrcAddress",
                              "type": "Microsoft.Common.TextBox",
                              "label": "Restricted source network or address",
                              "defaultValue": "*",
                              "toolTip": "Restricts management access to a specific network or address; enter a IP address or address range in CIDR notation, or asterisk for all sources.",
                              "constraints": {
                                   "regex": "^\\*$|^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/([0-9]|[1-2][0-9]|3[0-2]))$",
                                   "required": true,
                                   "validationMessage": "Only valid CIDR addresses and the wildcard character (asterisk) are allowed."
                              }
                         },
                         {
                              "name": "ntpServer",
                              "type": "Microsoft.Common.TextBox",
                              "label": "NTP Server",
                              "defaultValue": "0.pool.ntp.org",
                              "toolTip": "If you would like to change the NTP server the BIG-IP uses replace the default ntp server with your choice.",
                              "constraints": {
                                   "regex": "^([A-z0-9]+(-[A-z0-9]+)*\\.)+[a-z]{2,}|[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}$",
                                   "required": true,
                                   "validationMessage": "Only valid fully-qualified domain names are allowed."
                              }
                         },
                         {
                              "name": "timeZone",
                              "type": "Microsoft.Common.TextBox",
                              "label": "Time Zone",
                              "defaultValue": "UTC",
                              "toolTip": "If you would like to change the time zone the BIG-IP uses then enter your choice. This is in the format of the Olson timezone string from /usr/share/zoneinfo, such as UTC, US/Central or Europe/London.",
                              "constraints": {
                                   "required": true
                              }
                         }
                    ]
               },
               {
                    "name": "autoscaleSettings",
                    "label": "Autoscale Settings",
                    "subLabel": {
                         "preValidation": "Configure Autoscale Settings",
                         "postValidation": "Done"
                    },
                    "bladeTitle": "Autoscale Settings",
                    "elements": [
                        {
                            "name": "vmScaleSetMaxCount",
                             "type": "Microsoft.Common.DropDown",
                             "label": "VM Scale Set Maximum Count",
                             "defaultValue": "[string(add(int(steps('infrastructureSettings').vmScaleSetMinCount), 2))]",
                             "toolTip": "The maximum number of BIG-IP VEs that can be deployed into the VM Scale Set.",
                             "constraints": {
                                  "allowedValues": [
                                      {
                                           "label": "2",
                                           "value": "2"
                                      },
                                      {
                                           "label": "3",
                                           "value": "3"
                                      },
                                      {
                                           "label": "4",
                                           "value": "4"
                                      },
                                      {
                                           "label": "5",
                                           "value": "5"
                                      },
                                      {
                                           "label": "6",
                                           "value": "6"
                                      },
                                      {
                                           "label": "7",
                                           "value": "7"
                                      },
                                      {
                                           "label": "8",
                                           "value": "8"
                                      }
                                  ]
                             }
                        },
                        {
                            "name": "scaleOutThroughput",
                             "type": "Microsoft.Common.DropDown",
                             "label": "VM Scale Set Scale Out Throughput",
                             "defaultValue": "90",
                             "toolTip": "The percentage of 'Network Out' throughput that triggers a Scale Out event.  This is factored as a percentage of the F5 PAYG image bandwidth (Mbps) size you choose.",
                             "constraints": {
                                  "allowedValues": [
                                      {
                                           "label": "50",
                                           "value": "50"
                                      },
                                      {
                                           "label": "55",
                                           "value": "55"
                                      },
                                      {
                                           "label": "60",
                                           "value": "60"
                                      },
                                      {
                                           "label": "65",
                                           "value": "65"
                                      },
                                      {
                                           "label": "70",
                                           "value": "70"
                                      },
                                      {
                                           "label": "75",
                                           "value": "75"
                                      },
                                      {
                                           "label": "80",
                                           "value": "80"
                                      },
                                      {
                                           "label": "85",
                                           "value": "85"
                                      },
                                      {
                                           "label": "90",
                                           "value": "90"
                                      },
                                      {
                                           "label": "95",
                                           "value": "95"
                                      }
                                  ]
                             }
                        },
                        {
                            "name": "scaleInThroughput",
                             "type": "Microsoft.Common.DropDown",
                             "label": "VM Scale Set Scale In Throughput",
                             "defaultValue": "10",
                             "toolTip": "The percentage of 'Network Out' throughput that triggers a Scale In event.  This is factored as a percentage of the F5 PAYG image bandwidth (Mbps) size you choose.",
                             "constraints": {
                                  "allowedValues": [
                                      {
                                           "label": "5",
                                           "value": "5"
                                      },
                                      {
                                           "label": "10",
                                           "value": "10"
                                      },
                                      {
                                           "label": "15",
                                           "value": "15"
                                      },
                                      {
                                           "label": "20",
                                           "value": "20"
                                      },
                                      {
                                           "label": "25",
                                           "value": "25"
                                      },
                                      {
                                           "label": "30",
                                           "value": "30"
                                      },
                                      {
                                           "label": "35",
                                           "value": "35"
                                      },
                                      {
                                           "label": "40",
                                           "value": "40"
                                      },
                                      {
                                           "label": "45",
                                           "value": "45"
                                      }
                                  ]
                             }
                        },
                        {
                            "name": "scaleTimeWindow",
                             "type": "Microsoft.Common.DropDown",
                             "label": "VM Scale Set Scale Time Window",
                             "defaultValue": "10",
                             "toolTip": "The time window required to trigger a scale event (in and out). This is used to determine the amount of time needed for a threshold to be breached, as well as to prevent excessive scaling events (flapping).",
                             "constraints": {
                                  "allowedValues": [
                                      {
                                           "label": "5",
                                           "value": "5"
                                      },
                                      {
                                           "label": "10",
                                           "value": "10"
                                      },
                                      {
                                           "label": "15",
                                           "value": "15"
                                      },
                                      {
                                           "label": "30",
                                           "value": "30"
                                      }
                                  ]
                             }
                        },
                        {
                              "name": "tenantId",
                              "type": "Microsoft.Common.TextBox",
                              "label": "Tenant ID",
                              "toolTip": "Your Azure service principal application tenant ID.",
                              "constraints": {
                                   "required": true,
                                   "validationMessage": "Please provide a valid tenant ID for your service prinicipal application."
                              }
                         },
                         {
                               "name": "clientId",
                               "type": "Microsoft.Common.TextBox",
                               "label": "Client ID",
                               "toolTip": "Your Azure service principal application client ID.",
                               "constraints": {
                                    "required": true,
                                    "validationMessage": "Please provide a valid client ID for your service prinicipal application."
                               }
                          },
                          {
                                "name": "servicePrincipalSecret",
                                "type": "Microsoft.Common.TextBox",
                                "label": "Secret",
                                "toolTip": "Your Azure service principal application secret.",
                                "constraints": {
                                     "required": true,
                                     "validationMessage": "Please provide a valid secret key for your service prinicipal application."
                                }
                           },
                           {
                                 "name": "customEmail",
                                 "type": "Microsoft.Common.TextBox",
                                 "label": "Email for Scale Event Notifications",
                                 "toolTip": "An email address that will receive notifications of scale events.",
                                 "constraints": {
                                     "regex": ".+\\@.+\\..+",
                                      "required": false,
                                      "validationMessage": "Please provide a valid email address."
                                 }
                            }
                    ]
               }
          ],
          "outputs": {
               "location": "[location()]",
               "solutionDeploymentName": "[steps('infrastructureSettings').solutionDeploymentName]",
               "adminUsername": "[steps('infrastructureSettings').adminUsername]",
               "adminPassword": "[steps('infrastructureSettings').adminPassword.password]",
               "licensedBandwidth": "[steps('infrastructureSettings').licensedBandwidth]",
               "instanceType": "[steps('infrastructureSettings').instanceType]",
               "imageName": "[steps('infrastructureSettings').imageName]",
               "bigIpVersion": "[steps('infrastructureSettings').bigIpVersion]",
               "managedDisks": "[steps('infrastructureSettings').managedDisks]",
               "storageAccountNewOrExisting": "[steps('infrastructureSettings').storageAccount.newOrExisting]",
               "storageAccountExistingRGName": "[steps('infrastructureSettings').storageAccount.resourceGroup]",
               "storageAccountName": "[steps('infrastructureSettings').storageAccount.name]",
               "storageAccountType": "[steps('infrastructureSettings').storageAccount.type]",
               "publicIpNewOrExisting": "[steps('infrastructureSettings').publicIp.newOrExistingOrNone]",
               "publicIpExistingRGName": "[steps('infrastructureSettings').publicIp.resourceGroup]",
               "publicIpName": "[steps('infrastructureSettings').publicIp.name]",
               "dnsLabel": "[steps('infrastructureSettings').publicIp.domainNameLabel]",
               "vnetNewOrExisting": "[steps('infrastructureSettings').virtualNetwork.newOrExisting]",
               "vnetName": "[steps('infrastructureSettings').virtualNetwork.name]",
               "vnetExistingRGName": "[steps('infrastructureSettings').virtualNetwork.resourceGroup]",
               "vnetAddressPrefix": "[steps('infrastructureSettings').virtualNetwork.addressPrefix]",
               "subnetName": "[steps('infrastructureSettings').virtualNetwork.subnets.subnet1.name]",
               "subnetAddressPrefix": "[steps('infrastructureSettings').virtualNetwork.subnets.subnet1.addressPrefix]",
               "privateIpAddressRangeStart": "[steps('infrastructureSettings').virtualNetwork.subnets.subnet1.startAddress]",
               "restrictedSrcAddress": "[steps('infrastructureSettings').restrictedSrcAddress]",
               "ntpServer": "[steps('infrastructureSettings').ntpServer]",
               "timeZone": "[steps('infrastructureSettings').timeZone]",
               "vmScaleSetMinCount": "[int(steps('infrastructureSettings').vmScaleSetMinCount)]",
               "vmScaleSetMaxCount": "[int(steps('autoscaleSettings').vmScaleSetMaxCount)]",
               "scaleOutThroughput": "[int(steps('autoscaleSettings').scaleOutThroughput)]",
               "scaleInThroughput": "[int(steps('autoscaleSettings').scaleInThroughput)]",
               "scaleTimeWindow": "[int(steps('autoscaleSettings').scaleTimeWindow)]",
               "customEmail": "[steps('autoscaleSettings').customEmail]",
               "tenantId": "[steps('autoscaleSettings').tenantId]",
               "clientId": "[steps('autoscaleSettings').clientId]",
               "servicePrincipalSecret": "[steps('autoscaleSettings').servicePrincipalSecret]"
          }
     }
}
